e_0=8.85e-12;%Permitividad del vacï¿½o
mu_0=pi*4e-7;%Permeabilidad del vacï¿½o
c=1/sqrt(e_0*mu_0);%Velocidad de la luz en el vacï¿½o
%Parï¿½metros del la placa
b=2e-3;%Espesor total de las dos capas dielï¿½ctricas mï¿½s aire entre estas en m
t=33e-6;%Espesor del conductor en m
cond=5.813e7;%Conductividad del conductor (Cobre)
%Parï¿½metros de construcciï¿½n
W=4e-3;%Ancho del camino conductor en m
l=0.1;%Longitud de la lï¿½nea en m
%Parï¿½metros de mediciï¿½n
f=2e9:0.05e9:3e9;%Vector con los valores de frecuencia en Hz sobre los que se midiï¿½
Zref=50;%Impedancia caracterï¿½stica de las lï¿½neas del VNA en Ohmios
%Resultados de la mediciï¿½n
%Calibraciï¿½n del VNA
cal_S11_dB=[-21.3475933074951,-22.7831859588623,-20.5986995697021,-28.9152374267578,-21.0209083557129,-27.7117004394531,-19.9011726379395,-26.4871101379395,-18.8058681488037,-26.3981475830078,-17.7603340148926,-26.0684375762939,-17.4778099060059,-25.2237701416016,-17.6047058105469,-23.9012031555176,-18.4733753204346,-23.3429622650146,-19.8934230804443,-22.5046615600586,-21.5443897247314];
cal_S11_deg=[-151.959747314453,-349.532073974609,-586.483703613281,-748.708801269531,-996.656311035156,-1135.92321777344,-1400.38647460938,-1537.09423828125,-1799.06860351563,-1937.05383300781,-2196.75366210938,-2337.58984375,-2595.23071289063,-2747.01831054688,-2989.99438476563,-3153.5302734375,-3381.90161132813,-3555.5283203125,-3774.04418945313,-3955.5390625,-4167.12255859375];
cal_S21_dB=[-3.92806529998779e-02,-0.020855288952589,0.052651260048151,-9.56032276153564e-02,-5.96819557249546e-02,-0.101689361035824,-0.228095158934593,-0.117695152759552,-0.416193604469299,-0.204595416784286,-0.487559795379639,-0.213815122842789,-0.339172184467316,-0.18274137377739,-0.216461569070816,-0.173449218273163,-0.183401674032211,-0.163593411445618,-0.202559545636177,-0.192797303199768,-0.247147560119629];
cal_S21_deg=[106.241165161133,99.8961334228516,92.0555114746094,86.3123626708984,78.542724609375,73.2924652099609,65.4589614868164,60.2441291809082,53.1830978393555,47.4468765258789,41.8338508605957,35.2873992919922,30.1636085510254,22.6412315368652,17.1017436981201,9.72041702270508,3.91837167739868,-3.33412551879883,-9.1939582824707,-16.3255252838135,-22.0171318054199];
%Matriz ABCD de la Calibraciï¿½n
cal_S11=1:1:21;
cal_S21=1:1:21;
ABCD_con=eye(2);
ABCD1=zeros(4,21);
S_1=zeros(4,21);
for i1=1:1:21
    cal_S11(i1)=(10^(cal_S11_dB(i1)/20))*(cosd(cal_S11_deg(i1))+1i*sind(cal_S11_deg(i1)));
    cal_S21(i1)=(10^(cal_S21_dB(i1)/20))*(cosd(cal_S21_deg(i1))+1i*sind(cal_S21_deg(i1)));
    cal_S=[ cal_S11(i1),cal_S21(i1);cal_S21(i1),cal_S11(i1)];
    ABCD_con=s2abcd(cal_S,Zref);
    ABCD_p=sqrtm(ABCD_con);
    ABCD1(:,i1)=[ABCD_p(1,1);ABCD_p(1,2);ABCD_p(2,1);ABCD_p(2,2)];
    S_t=abcd2s([ABCD1(1,i1),ABCD1(2,i1);ABCD1(3,i1),ABCD1(4,i1)],Zref);
    S_1(:,i1)=[S_t(1,1);S_t(1,2);S_t(2,1);S_t(2,2)];
    clear ABCD_p ABCD_con ABCD_t cal_S S_t;
end
clear i1;
%Mediciï¿½n del Prototipo
med_S11_dB=[-4.2359332e+00,-5.6454418e+00,-8.2855770e+00,-1.4044950e+01,-3.2883886e+01,-1.2432395e+01,-7.5721154e+00,-5.2417164e+00,-3.9846503e+00,-3.2870194e+00,-2.9236355e+00,-2.7912575e+00,-2.8578879e+00,-3.1427052e+00,-3.7224502e+00,-4.7813854e+00,-6.7279203e+00,-1.0642049e+01,-2.1949438e+01, -1.6530982e+01,-9.0601816e+00];
med_S11_deg=[1.5224571e+02,1.4027990e+02,1.2618691e+02,1.0970031e+02,-8.2966261e+01,-1.0447774e+02,-1.2059580e+02,-1.3434370e+02,-1.4600399e+02,-1.5612123e+02,-1.6523386e+02,-1.7386030e+02,1.7757475e+02,1.6863136e+02,1.5884859e+02,1.4764416e+02,1.3445415e+02,1.1879406e+02,9.9825306e+01,-9.4990781e+01,-1.1267829e+02];
med_S21_dB=[-2.0555195e+00,-1.3820092e+00,-6.9766265e-01,-1.7458236e-01,-2.2408021e-03,-2.5542384e-01,-8.3493599e-01,-1.5434952e+00,-2.2149957e+00,-2.7501658e+00,-3.0987338e+00,-3.2409842e+00,-3.1682604e+00,-2.8818166e+00,-2.3986461e+00,-1.7558393e+00,-1.0370913e+00,-3.9176431e-01,-2.7816093e-02,-9.7628605e-02,-5.7575673e-01];
med_S21_deg=[-1.1757450e+02,-1.2949549e+02,-1.4349824e+02,-1.5971132e+02,-1.7735484e+02,1.6520988e+02,1.4929988e+02,1.3563318e+02,1.2401967e+02,1.1393674e+02,1.0485270e+02,9.6253683e+01,8.7718163e+01,7.8808123e+01,6.9068518e+01,5.7926545e+01,4.4840492e+01,2.9416173e+01,1.2009724e+01,-6.0065345e+00,-2.3001320e+01];
med_S12_dB=[-2.0555195e+00,-1.3820092e+00,-6.9766265e-01,-1.7458236e-01,-2.2408021e-03,-2.5542384e-01,-8.3493599e-01,-1.5434952e+00,-2.2149957e+00,-2.7501658e+00,-3.0987338e+00,-3.2409842e+00,-3.1682604e+00,-2.8818166e+00,-2.3986461e+00,-1.7558393e+00,-1.0370913e+00,-3.9176431e-01,-2.7816093e-02,-9.7628605e-02,-5.7575673e-01];
med_S12_deg=[-1.1757450e+02,-1.2949549e+02,-1.4349824e+02,-1.5971132e+02,-1.7735484e+02,1.6520988e+02,1.4929988e+02,1.3563318e+02,1.2401967e+02,1.1393674e+02,1.0485270e+02,9.6253683e+01,8.7718163e+01,7.8808123e+01,6.9068518e+01,5.7926545e+01,4.4840492e+01,2.9416173e+01,1.2009724e+01,-6.0065345e+00,-2.3001320e+01];
med_S22_dB=[-4.2359332e+00,-5.6454418e+00,-8.2855770e+00,-1.4044950e+01,-3.2883864e+01,-1.2432395e+01,-7.5721153e+00,-5.2417163e+00,-3.9846503e+00,-3.2870193e+00,-2.9236355e+00,-2.7912575e+00,-2.8578879e+00,-3.1427052e+00,-3.7224501e+00,-4.7813853e+00,-6.7279202e+00,-1.0642048e+01,-2.1949436e+01,-1.6530981e+01,-9.0601815e+00];
med_S22_deg=[1.5260532e+02,1.4072916e+02,1.2681669e+02,1.1087724e+02,-9.1745277e+01,-1.0510269e+02,-1.2080453e+02,-1.3438999e+02,-1.4595672e+02,-1.5600531e+02,-1.6506074e+02,-1.7363234e+02,1.7786158e+02,1.6898490e+02,1.5928847e+02,1.4820897e+02,1.3522690e+02,1.2003840e+02,1.0419463e+02,-9.7022548e+01,-1.1332445e+02];
%Matrices ABCD y S de la Medición
med_S11=1:1:21;
med_S21=1:1:21;
med_S12=1:1:21;
med_S22=1:1:21;
ABCD_med=eye(2);
S_p=eye(2);
ABCDr=zeros(4,21);
S_r=zeros(4,21);
for i1=1:1:21
     med_S11(i1)=(10^(med_S11_dB(i1)/20))*(cosd(med_S11_deg(i1))+1i*sind(med_S11_deg(i1)));
     med_S21(i1)=(10^(med_S21_dB(i1)/20))*(cosd(med_S21_deg(i1))+1i*sind(med_S21_deg(i1)));
     med_S12(i1)=(10^(med_S12_dB(i1)/20))*(cosd(med_S12_deg(i1))+1i*sind(med_S12_deg(i1)));
     med_S22(i1)=(10^(med_S22_dB(i1)/20))*(cosd(med_S22_deg(i1))+1i*sind(med_S22_deg(i1)));
     med_S=[ med_S11(i1),med_S12(i1);med_S21(i1),med_S22(i1)];
     ABCD_med=s2abcd(med_S,Zref);
     ABCD_p=[ABCD1(1,i1),ABCD1(2,i1);ABCD1(3,i1),ABCD1(4,i1)]\ABCD_med/[ABCD1(1,i1),ABCD1(2,i1);ABCD1(3,i1),ABCD1(4,i1)];
     ABCDr(:,i1)=[ABCD_p(1,1);ABCD_p(1,2);ABCD_p(2,1);ABCD_p(2,2)];
     S_p=abcd2s([ABCDr(1,i1),ABCDr(2,i1);ABCDr(3,i1),ABCDr(4,i1)],Zref);
     S_r(:,i1)=[S_p(1,1);S_p(1,2);S_p(2,1);S_p(2,2)];
     clear ABCD_p ABCD_med med_S S_p;
end
clear i1;

%Cï¿½lculo de Permitividad Relativa y Tangente de Pï¿½rdidas
%Con S11 y S21
A_s=1:1:21;
E_s=1:1:21;
Alfa_s=1:1:21;
Beta_s=1:1:21;
Gama_s=1:1:21;
er_s=1:1:21;
tand_s=1:1:21;
Zc_s=1:1:21;
alfa_cs=1:1:21;
for i1=1:1:21
    an=-(S_r(1,i1)^2)-(2*S_r(1,i1))+(S_r(3,i1)^2)-1;
    ad=-(S_r(1,i1)^2)+(2*S_r(1,i1))+(S_r(3,i1)^2)-1;
    A_s(i1)=sqrt(an/ad);
    E_s(i1)=(S_r(3,i1)*(0.5*A_s(i1)+0.5))-((S_r(1,i1)-1)*(S_r(1,i1)+(S_r(1,i1)*A_s(i1))-A_s(i1)+1)/(2*S_r(3,i1)));
    Gama_s(i1)=(4i*pi-log(E_s(i1)))/l;
    Alfa_s(i1)=real(Gama_s(i1));
    Beta_s(i1)=imag(Gama_s(i1));
    er_s(i1)=(c*Beta_s(i1)/(2*pi*f(i1)))^2;
    Zc_s(i1)=Zref*A_s(i1);
    if Zc_s(i1)*sqrt(er_s(i1))<120
        a_c=1+(2*W/(b-t))+(b+t)*log((2*b-t)/t)/(b-t);
        alfa_cs(i1)=a_c*2.7e-3*sqrt(mu_0*pi*f(i1)/cond)*er_s(i1)*real(Zc_s(i1))/(30*pi*(b-t));
        clear a_c;
    else
        a_c=1+(b/(0.5*W+0.7*t))*(0.5+(0.414*t/W)+log(4*pi*W/t)/(2*pi));
        alfa_cs(i1)=a_c*0.16*sqrt(mu_0*pi*f(i1)/cond)/(real(Zc_s(i1))*b);
        clear a_c;
    end
    tand_s(i1)=2*(Alfa_s(i1)-alfa_cs(i1))/Beta_s(i1)+0.015;
    clear ad an a_c E_s;
end
%con ABCD
Zc_abcd=1:1:21;
Alfa_abcd=1:1:21;
Beta_abcd=1:1:21;
Gama_abcd=1:1:21;
er_abcd=1:1:21;
alfa_cabcd=1:1:21;
tand_abcd=1:1:21;
for i1=1:1:21;
    Zc_abcd(i1)=sqrt(ABCDr(2,i1)/ABCDr(3,i1));
    if imag(acosh(ABCDr(1,i1)))<0
        Gama_abcd(i1)=(acosh(ABCDr(1,i1))+4i*pi)/l;
    else
        Gama_abcd(i1)=(-acosh(ABCDr(1,i1))+4i*pi)/l;
    end
    Alfa_abcd(i1)=real(Gama_abcd(i1));
    Beta_abcd(i1)=imag(Gama_abcd(i1));
    er_abcd(i1)=(c*Beta_abcd(i1)/(2*pi*f(i1)))^2;
    if Zc_abcd(i1)*sqrt(er_abcd(i1))<120
        a_c=1+(2*W/(b-t))+(b+t)*log((2*b-t)/t)/(b-t);
        alfa_cabcd(i1)=a_c*2.7e-3*sqrt(mu_0*pi*f(i1)/cond)*er_abcd(i1)*real(Zc_abcd(i1))/(30*pi*(b-t));
        clear a_c;
    else
        a_c=1+(b/(0.5*W+0.7*t))*(0.5+(0.414*t/W)+log(4*pi*W/t)/(2*pi));
        alfa_cabcd(i1)=a_c*0.16*sqrt(mu_0*pi*f(i1)/cond)/(real(Zc_abcd(i1))*b);
        clear a_c;
    end
    tand_abcd(i1)=2*(Alfa_abcd(i1)-alfa_cabcd(i1))/Beta_abcd(i1)+0.015;
    clear ad an a_c;
end
clear i1;
%Gráficas
%Parï¿½metros S 
figure;[s11,Plot_S11]=smithchart(S_r(1,:));
figure;[s12,Plot_S12]=smithchart(S_r(2,:));
figure;[s21,Plot_S21]=smithchart(S_r(3,:));
figure;[s22,Plot_S22]=smithchart(S_r(4,:));
%Parámetros Eléctricos
figure;plot(f,er_s,'.',f,er_abcd,'+');
figure;plot(f,tand_s,'.',f,tand_abcd,'+');